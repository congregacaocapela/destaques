<!DOCTYPE html>
<html lang="pt-br" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudo Pessoal</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/pw/AP1GczP6O7T9Df_GZb1K2fuF1p49BlTc8wY3BuChHezCEFbr_knqISjsKGQp9ham81jh1en611SYYgNWsTNQthqDPZ0PvRac69ikrHRZ9X0vQOCifx2fPvbLm9NkPjEVPArzDG7x-68dKx33RAnHhc0qx0SeaA=w898-h898-s-no-gm?authuser=0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configura o Tailwind CSS para usar a estratégia de 'class' para o modo escuro.
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-custom-blue {
            background-color: #3e5a8a;
        }
        .hover\:bg-custom-blue-dark:hover {
            background-color: #3e5a8a;
        }
        .tab-active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        .dark .tab-active {
            color: #60a5fa; /* text-blue-400 */
            border-bottom-color: #60a5fa;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .dark .tab-inactive {
            color: #9ca3af; /* text-gray-400 */
        }
        .tab-inactive:hover {
            color: #2563eb;
        }
        .dark .tab-inactive:hover {
            color: #60a5fa;
        }
        /* Estilos para a notificação (Toast) */
        .toast {
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        /* Estilo para capítulo com destaque */
        .has-highlight {
            background-color: #4a6da7;
            color: white;
            border-color: #3e5a8a;
        }
        .has-highlight:hover {
            background-color: #3e5a8a;
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        /* Estilo para o seletor de pesquisa */
        .search-type-btn.active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        /* Oculta a barra de rolagem */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200" style="padding-top: 4rem;">

    <header class="fixed top-0 left-0 right-0 bg-custom-blue text-white p-4 shadow-md z-20 flex items-center justify-center" style="height: 4rem;">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
            <h1 class="text-xl font-bold">Estudo Pessoal</h1>
        </div>
        <div class="absolute right-4 top-1/2 -translate-y-1/2">
            <button id="notification-bell" class="relative">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path></svg>
                <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
            </button>
            <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-md shadow-lg z-30 border dark:border-gray-700">
                <div class="p-3 border-b dark:border-gray-700">
                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">Notificações</h3>
                </div>
                <div id="notification-list" class="py-1 max-h-96 overflow-y-auto">
                    <!-- Notificações serão inseridas aqui -->
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-2 sm:p-6 md:p-8 max-w-6xl">
        <div class="bg-white dark:bg-gray-800 shadow-md min-h-screen rounded-lg">

            <!-- Navegação com Abas -->
            <nav class="border-b border-gray-200 dark:border-gray-700 sticky bg-white dark:bg-gray-800 z-10 rounded-t-lg" style="top: 4rem;">
                <div class="px-4 py-3 flex items-center space-x-5 overflow-x-auto whitespace-nowrap no-scrollbar">
                    <a href="#" id="tab-livros" class="text-sm font-semibold pb-3 tab-active flex-shrink-0 flex items-center">
                        <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 1.25l-7.5 7.5 7.5 7.5 7.5-7.5-7.5-7.5z"></path></svg>
                        JOIAS
                    </a>
                    <a href="#" id="tab-pesquisas" class="text-sm font-semibold pb-3 tab-inactive flex-shrink-0 flex items-center">
                        <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 1.25l-7.5 7.5 7.5 7.5 7.5-7.5-7.5-7.5z"></path></svg>
                        PESQUISAS
                    </a>
                    <a href="#" id="tab-adicionar-destaque" class="text-sm font-semibold pb-3 tab-inactive flex-shrink-0">ADD. JOIA</a>
                    <a href="#" id="tab-adicionar-pesquisa" class="text-sm font-semibold pb-3 tab-inactive flex-shrink-0">ADD. PESQUISA</a>
                    <a href="#" id="tab-pesquisar" class="text-sm font-semibold pb-3 tab-inactive flex-shrink-0">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </a>
                </div>
            </nav>

            <!-- Visualização dos Livros -->
            <main id="view-livros">
                <div class="p-4 sm:p-8 space-y-8">
                    <section id="antigo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 dark:text-gray-400 mb-4">ESCRITURAS HEBRAICO-ARAMAICAS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></div>
                    </section>
                    <section id="novo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 dark:text-gray-400 mb-4">ESCRITURAS GREGAS CRISTÃS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></div>
                    </section>
                </div>
            </main>
            
            <!-- Visualização Adicionar Destaques -->
            <div id="view-adicionar-destaque" class="hidden p-4 sm:p-8 flex flex-col items-center">
                <div class="w-full max-w-lg">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Adicionar Joia</h2>
                    <form id="form-destaque" class="space-y-4">
                        <fieldset>
                            <div>
                                <label for="input-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                                <input type="text" id="input-autor" name="autor" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="select-livro" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Livro</label>
                                <select id="select-livro" name="livro" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="select-capitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Capítulo</label>
                                    <select id="select-capitulo" name="capitulo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required disabled>
                                        <option value="">Selecione o livro</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="input-versiculo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Versículo(s)</label>
                                    <input type="text" id="input-versiculo" name="versiculo" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 5 ou 5,6 ou 5-7" required>
                                </div>
                            </div>
                            <div>
                                <label for="textarea-destaque" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Joia</label>
                                <textarea id="textarea-destaque" name="destaque" rows="4" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Salvar Joia</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>

            <!-- Visualização de Pesquisa -->
            <div id="view-pesquisar" class="hidden p-4 sm:p-8 flex flex-col items-center">
                 <div class="w-full max-w-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Pesquisar</h2>
                    <div id="search-type-selector" class="flex justify-center mb-4 border border-gray-300 dark:border-gray-600 rounded-lg p-1 max-w-xs mx-auto">
                        <button id="search-type-joias" class="search-type-btn active w-1/2 py-1 rounded-md text-sm">Joias</button>
                        <button id="search-type-pesquisas" class="search-type-btn w-1/2 py-1 rounded-md text-sm">Pesquisas</button>
                    </div>
                    <form id="form-pesquisa" class="flex gap-2 mb-8">
                        <input type="search" id="input-pesquisa" class="block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Digite uma palavra-chave...">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Buscar</button>
                    </form>
                    <div id="container-resultados" class="space-y-4">
                        <!-- Resultados da pesquisa aparecerão aqui -->
                    </div>
                </div>
            </div>

            <!-- Visualização dos Capítulos (Grid de números) -->
            <div id="view-capitulos" class="hidden">
                 <header class="p-4 sm:p-6 border-b dark:border-gray-700">
                    <button id="btn-voltar-livros" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mb-6">&larr; Voltar para Livros</button>
                    <div class="flex items-center justify-between">
                        <button id="btn-livro-anterior" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h1 id="titulo-livro-capitulos" class="text-xl sm:text-3xl font-bold text-slate-800 dark:text-slate-100 text-center mx-2"></h1>
                        <button id="btn-livro-seguinte" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                </header>
                <div class="p-4 sm:p-8">
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Capítulos</h3>
                    <div id="grid-capitulos" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-12 gap-2"></div>
                </div>
            </div>

            <!-- Visualização do Conteúdo do Capítulo (com destaques) -->
            <div id="view-conteudo" class="hidden">
                <header class="p-4 sm:p-6 border-b dark:border-gray-700">
                    <button id="btn-voltar-capitulos" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mb-6">&larr; Voltar para Capítulos</button>
                    <h1 id="titulo-conteudo" class="text-3xl font-bold text-slate-800 dark:text-slate-100"></h1>
                </header>
                <div id="destaques-container" class="p-4 sm:p-8 space-y-4"></div>
            </div>
            
            <!-- Visualização de Pesquisas Salvas -->
            <div id="view-pesquisas" class="hidden p-4 sm:p-8">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Pesquisas Salvas</h2>
                <div id="container-pesquisas" class="space-y-4 max-w-4xl mx-auto"></div>
            </div>
            
            <!-- Visualização Adicionar Pesquisa -->
            <div id="view-adicionar-pesquisa" class="hidden p-4 sm:p-8 flex flex-col items-center">
                <div class="w-full max-w-lg">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Adicionar Pesquisa</h2>
                    <form id="form-adicionar-pesquisa" class="space-y-4">
                        <fieldset>
                             <div>
                                <label for="input-pesquisa-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                                <input type="text" id="input-pesquisa-autor" name="autor" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="input-pesquisa-titulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título</label>
                                <input type="text" id="input-pesquisa-titulo" name="titulo" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="input-pesquisa-tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tags (separadas por vírgula)</label>
                                <input type="text" id="input-pesquisa-tags" name="tags" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: estudo, oração">
                            </div>
                             <div>
                                <label for="textarea-pesquisa-texto-biblico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Texto Bíblico (Opcional)</label>
                                <textarea id="textarea-pesquisa-texto-biblico" name="textoBiblico" rows="1" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label for="textarea-pesquisa-anotacoes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Anotações</label>
                                <textarea id="textarea-pesquisa-anotacoes" name="anotacoes" rows="8" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 disabled:cursor-not-allowed text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Salvar Pesquisa</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>

        </div>
        <footer class="text-center py-4">
            <p class="text-sm text-gray-500 dark:text-gray-400">Desenvolvido por Guilherme Almeida</p>
        </footer>
    </div>

    <!-- Container para as notificações (Toasts) -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <!-- Modal de Senha -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 modal-overlay">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <h3 id="password-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Para continuar, por favor, insira a senha.</p>
                    <input type="password" id="password-input" placeholder="Senha" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Senha incorreta.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="cancel-password-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 mr-2">Cancelar</button>
                    <button id="confirm-password-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 modal-overlay">
         <div class="relative top-10 mx-auto p-5 border border-gray-200 dark:border-gray-700 w-11/12 max-w-lg shadow-lg rounded-md bg-white dark:bg-gray-800">
             <h2 id="edit-modal-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center"></h2>
             <form id="form-edit" class="space-y-4">
                 <!-- Campos do formulário de edição serão preenchidos via JS -->
             </form>
         </div>
    </div>

    <!-- Botão de Tema (Sol/Lua) -->
    <button id="theme-toggle" class="fixed bottom-5 right-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full p-3 shadow-lg focus:outline-none">
        <svg id="theme-toggle-sun" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414z"></path></svg>
        <svg id="theme-toggle-moon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
    </button>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, setLogLevel, doc, deleteDoc, getDoc, updateDoc, onSnapshot, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAKG3DUkXfs1DzkJqK9gNW3NbBsQUmtYVo",
            authDomain: "destaques-627c7.firebaseapp.com",
            projectId: "destaques-627c7",
            storageBucket: "destaques-627c7.firebasestorage.app",
            messagingSenderId: "748367852239",
            appId: "1:748367852239:web:ef84cffe6355e87392bdba",
            measurementId: "G-1LRM7D0MY1"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId || 'default-app-id';
        setLogLevel('debug');

        let acaoPendente = { type: null, docId: null, collection: null };
        const destaquesCollectionPath = `/artifacts/${appId}/public/data/destaques`;
        const pesquisasCollectionPath = `/artifacts/${appId}/public/data/pesquisas`;

        const biblia = {
            "Antigo Testamento": {"Gênesis": 50, "Êxodo": 40, "Levítico": 27, "Números": 36, "Deuteronômio": 34, "Josué": 24, "Juízes": 21, "Rute": 4, "1 Samuel": 31, "2 Samuel": 24, "1 Reis": 22, "2 Reis": 25, "1 Crônicas": 29, "2 Crônicas": 36, "Esdras": 10, "Neemias": 13, "Ester": 10, "Jó": 42, "Salmos": 150, "Provérbios": 31, "Eclesiastes": 12, "Cântico de Salomão": 8, "Isaías": 66, "Jeremias": 52, "Lamentações": 5, "Ezequiel": 48, "Daniel": 12, "Oseias": 14, "Joel": 3, "Amós": 9, "Obadias": 1, "Jonas": 4, "Miqueias": 7, "Naum": 3, "Habacuque": 3, "Sofonias": 3, "Ageu": 2, "Zacarias": 14, "Malaquias": 4},
            "Novo Testamento": {"Mateus": 28, "Marcos": 16, "Lucas": 24, "João": 21, "Atos": 28, "Romanos": 16, "1 Coríntios": 16, "2 Coríntios": 13, "Gálatas": 6, "Efésios": 6, "Filipenses": 4, "Colossenses": 4, "1 Tessalonicenses": 5, "2 Tessalonicenses": 3, "1 Timóteo": 6, "2 Timóteo": 4, "Tito": 3, "Filemom": 1, "Hebreus": 13, "Tiago": 5, "1 Pedro": 5, "2 Pedro": 3, "1 João": 5, "2 João": 1, "3 João": 1, "Judas": 1, "Apocalipse": 22}
        };
        
        const allBooks = [...Object.keys(biblia["Antigo Testamento"]), ...Object.keys(biblia["Novo Testamento"])];
        const allChapters = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
        let estadoAtual = { livro: null, capitulo: null };

        const views = {
            livros: document.getElementById('view-livros'),
            adicionarDestaque: document.getElementById('view-adicionar-destaque'),
            pesquisar: document.getElementById('view-pesquisar'),
            pesquisas: document.getElementById('view-pesquisas'),
            adicionarPesquisa: document.getElementById('view-adicionar-pesquisa'),
            capitulos: document.getElementById('view-capitulos'),
            conteudo: document.getElementById('view-conteudo'),
        };
        const tabs = {
            livros: document.getElementById('tab-livros'),
            adicionarDestaque: document.getElementById('tab-adicionar-destaque'),
            pesquisar: document.getElementById('tab-pesquisar'),
            pesquisas: document.getElementById('tab-pesquisas'),
            adicionarPesquisa: document.getElementById('tab-adicionar-pesquisa'),
        };
        const formDestaque = document.getElementById('form-destaque');
        const formPesquisa = document.getElementById('form-pesquisa');
        const formAdicionarPesquisa = document.getElementById('form-adicionar-pesquisa');
        const selectLivro = document.getElementById('select-livro');
        const selectCapitulo = document.getElementById('select-capitulo');
        const passwordModal = document.getElementById('password-modal');
        const editModal = document.getElementById('edit-modal');
        const passwordError = document.getElementById('password-error');
        
        function showToast(message, isSuccess = true) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = isSuccess ? 'bg-green-500' : 'bg-red-500';
            toast.className = `toast text-white p-4 rounded-md shadow-lg flex items-center justify-between ${bgColor}`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            toast.appendChild(messageSpan);

            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function copiarTexto(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast("Texto copiado!");
            } catch (err) {
                console.error('Falha ao copiar', err);
                showToast("Falha ao copiar.", false);
            }
            document.body.removeChild(textArea);
        }

        function esconderTudo() { Object.values(views).forEach(view => view.classList.add('hidden')); }

        function popularSelectLivros() {
            selectLivro.innerHTML = '<option value="" disabled selected>Selecione um livro</option>';
            const todosLivros = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
            Object.keys(todosLivros).forEach(livro => {
                const option = document.createElement('option');
                option.value = livro;
                option.textContent = livro;
                selectLivro.appendChild(option);
            });
        }

        async function salvarDestaque(event) {
            event.preventDefault();
            const submitButton = formDestaque.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                const formData = new FormData(formDestaque);
                const destaqueData = {
                    autor: formData.get('autor'),
                    livro: formData.get('livro'),
                    capitulo: parseInt(formData.get('capitulo'), 10),
                    versiculo: formData.get('versiculo'),
                    texto: formData.get('destaque'),
                    createdAt: new Date()
                };

                await addDoc(collection(db, destaquesCollectionPath), destaqueData);
                showToast("Joia salva com sucesso!");
                formDestaque.reset();
                selectCapitulo.disabled = true;
                selectCapitulo.innerHTML = '<option value="">Selecione o livro</option>';
                popularLivros();
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showToast("Falha ao salvar a joia.", false);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Salvar Joia';
            }
        }

        async function salvarPesquisa(event) {
            event.preventDefault();
            const submitButton = formAdicionarPesquisa.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                const formData = new FormData(formAdicionarPesquisa);
                const pesquisaData = {
                    autor: formData.get('autor'),
                    titulo: formData.get('titulo'),
                    tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                    textoBiblico: formData.get('textoBiblico'),
                    anotacoes: formData.get('anotacoes'),
                    createdAt: new Date()
                };

                await addDoc(collection(db, pesquisasCollectionPath), pesquisaData);
                showToast("Pesquisa salva com sucesso!");
                formAdicionarPesquisa.reset();
            } catch (e) {
                console.error("Erro ao salvar pesquisa: ", e);
                showToast("Falha ao salvar a pesquisa.", false);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Salvar Pesquisa';
            }
        }

        async function popularLivros() {
            const containerAntigo = document.querySelector('#antigo-testamento .grid');
            const containerNovo = document.querySelector('#novo-testamento .grid');
            containerAntigo.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Carregando livros...</p>';
            containerNovo.innerHTML = '';

            const livrosComDestaque = new Set();
            try {
                const querySnapshot = await getDocs(collection(db, destaquesCollectionPath));
                querySnapshot.forEach((doc) => {
                    livrosComDestaque.add(doc.data().livro);
                });
            } catch(e) {
                console.error("Erro ao buscar destaques dos livros: ", e);
                showToast("Não foi possível verificar os destaques dos livros.", false);
            }

            containerAntigo.innerHTML = '';
            containerNovo.innerHTML = '';

            const criarBotao = (nome, caps, temDestaque) => {
                const div = document.createElement('div');
                div.textContent = nome;
                let classes = 'font-medium p-4 text-center cursor-pointer transition-colors duration-200';
                if (temDestaque) {
                    classes += ' bg-custom-blue hover:bg-custom-blue-dark text-white';
                } else {
                    classes += ' bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200';
                }
                div.className = classes;
                div.onclick = () => mostrarCapitulos(nome, caps);
                return div;
            };

            Object.entries(biblia["Antigo Testamento"]).forEach(([livro, caps]) => {
                containerAntigo.appendChild(criarBotao(livro, caps, livrosComDestaque.has(livro)));
            });
            Object.entries(biblia["Novo Testamento"]).forEach(([livro, caps]) => {
                containerNovo.appendChild(criarBotao(livro, caps, livrosComDestaque.has(livro)));
            });
        }

        async function mostrarCapitulos(nomeLivro, numCapitulos) {
            estadoAtual.livro = nomeLivro;
            esconderTudo();
            views.capitulos.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-livro-capitulos').textContent = `O Livro de ${nomeLivro}`;
            
            const btnAnterior = document.getElementById('btn-livro-anterior');
            const btnSeguinte = document.getElementById('btn-livro-seguinte');
            const currentIndex = allBooks.indexOf(nomeLivro);

            if (currentIndex > 0) {
                const livroAnterior = allBooks[currentIndex - 1];
                const capsAnterior = allChapters[livroAnterior];
                btnAnterior.onclick = () => mostrarCapitulos(livroAnterior, capsAnterior);
                btnAnterior.disabled = false;
                btnAnterior.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnAnterior.onclick = null;
                btnAnterior.disabled = true;
                btnAnterior.classList.add('opacity-50', 'cursor-not-allowed');
            }

            if (currentIndex < allBooks.length - 1) {
                const livroSeguinte = allBooks[currentIndex + 1];
                const capsSeguinte = allChapters[livroSeguinte];
                btnSeguinte.onclick = () => mostrarCapitulos(livroSeguinte, capsSeguinte);
                btnSeguinte.disabled = false;
                btnSeguinte.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btnSeguinte.onclick = null;
                btnSeguinte.disabled = true;
                btnSeguinte.classList.add('opacity-50', 'cursor-not-allowed');
            }

            const grid = document.getElementById('grid-capitulos');
            grid.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Verificando destaques...</p>';

            const capitulosComDestaque = new Set();
            try {
                const q = query(collection(db, destaquesCollectionPath), where("livro", "==", nomeLivro));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    capitulosComDestaque.add(doc.data().capitulo);
                });
            } catch (e) {
                console.error("Erro ao verificar destaques: ", e);
                showToast("Erro ao verificar destaques.", false);
            }

            grid.innerHTML = '';

            for (let i = 1; i <= numCapitulos; i++) {
                const capButton = document.createElement('button');
                capButton.textContent = i;
                let classes = 'border rounded-sm p-2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200';
                
                if (capitulosComDestaque.has(i)) {
                    classes += ' has-highlight';
                } else {
                    classes += ' border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700';
                }
                
                capButton.className = classes;
                capButton.onclick = () => mostrarConteudo(nomeLivro, i);
                grid.appendChild(capButton);
            }
        }
        
        async function deletarItem(docId, collectionPath) {
            if (!docId) {
                showToast("Erro ao deletar: ID do documento ausente.", false);
                return;
            }
            try {
                await deleteDoc(doc(db, collectionPath, docId));
                showToast("Item removido.");
                
                if (collectionPath === destaquesCollectionPath) {
                    if (document.getElementById('view-conteudo').classList.contains('hidden')) {
                        document.getElementById('form-pesquisa').requestSubmit();
                    } else {
                        await mostrarConteudo(estadoAtual.livro, estadoAtual.capitulo);
                    }
                    popularLivros();
                } else if (collectionPath === pesquisasCollectionPath) {
                    mostrarPesquisas();
                }

            } catch (error) {
                console.error("Erro ao deletar item: ", error);
                showToast("Falha ao remover o item.", false);
            }
        }

        function criarCardDestaque(destaque) {
            const { id, versiculo, texto, autor, livro, capitulo } = destaque;
            const card = document.createElement('div');
            card.className = 'relative border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50';
            
            const isSearchView = !document.getElementById('view-pesquisar').classList.contains('hidden');
            const referencia = isSearchView ? `<p class="font-semibold text-gray-600 dark:text-gray-300 text-sm mb-2">${livro} ${capitulo}</p>` : '';

            const textoId = `texto-${id}`;
            const toggleBtnId = `toggle-btn-texto-${id}`;
            let textoHTML = '';
            const MAX_LENGTH = 250; 

            if (texto && texto.length > MAX_LENGTH) {
                const textoTruncado = texto.substring(0, MAX_LENGTH) + '...';
                textoHTML = `
                    <div>
                        <p id="${textoId}" class="mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${textoTruncado}</p>
                        <button id="${toggleBtnId}" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mt-2">Mostrar tudo</button>
                    </div>
                `;
            } else {
                textoHTML = `<p class="mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${texto || ''}</p>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <p class="font-bold text-blue-600 dark:text-blue-400">Versículo(s) ${versiculo}</p>
                    <div class="flex">
                         <button class="copy-btn text-gray-400 hover:text-green-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                        </button>
                        <button class="edit-btn text-gray-400 hover:text-blue-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    ${referencia}
                    ${textoHTML}
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 italic">Destaque de: ${autor || 'Anônimo'}</p>
                </div>
            `;

            if (texto && texto.length > MAX_LENGTH) {
                const toggleBtn = card.querySelector(`#${toggleBtnId}`);
                const textoP = card.querySelector(`#${textoId}`);
                let isTruncated = true;

                toggleBtn.addEventListener('click', () => {
                    isTruncated = !isTruncated;
                    if (isTruncated) {
                        textoP.textContent = texto.substring(0, MAX_LENGTH) + '...';
                        toggleBtn.textContent = 'Mostrar tudo';
                    } else {
                        textoP.textContent = texto;
                        toggleBtn.textContent = 'Mostrar menos';
                    }
                });
            }

            return card;
        }

        function criarCardPesquisa(pesquisa) {
            const { id, titulo, tags, textoBiblico, anotacoes, autor } = pesquisa;
            const card = document.createElement('div');
            card.className = 'relative border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-800 shadow-sm';

            const tagsHTML = tags && tags.length > 0
                ? `<div class="flex flex-wrap gap-2 mb-3">${tags.map(tag => `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-medium px-2.5 py-0.5 rounded-full">${tag}</span>`).join('')}</div>`
                : '';

            const textoBiblicoHTML = textoBiblico
                ? `<blockquote class="border-l-4 border-gray-300 dark:border-gray-600 pl-4 py-2 my-4 bg-gray-50 dark:bg-gray-700/50 rounded-r-lg"><p class="italic text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${textoBiblico}</p></blockquote>`
                : '';
            
            const anotacoesId = `anotacoes-${id}`;
            const toggleBtnId = `toggle-btn-${id}`;
            let anotacoesHTML = '';
            const MAX_LENGTH = 250; // Limite de caracteres para truncar

            if (anotacoes && anotacoes.length > MAX_LENGTH) {
                const textoTruncado = anotacoes.substring(0, MAX_LENGTH) + '...';
                anotacoesHTML = `
                    <div>
                        <p id="${anotacoesId}" class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${textoTruncado}</p>
                        <button id="${toggleBtnId}" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mt-2">Mostrar tudo</button>
                    </div>
                `;
            } else {
                anotacoesHTML = `<p class="text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${anotacoes || ''}</p>`;
            }

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">${titulo}</h3>
                    <div class="flex">
                        <button class="copy-btn text-gray-400 hover:text-green-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path></svg>
                        </button>
                        <button class="edit-btn text-gray-400 hover:text-blue-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button class="delete-btn text-gray-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                ${tagsHTML}
                ${textoBiblicoHTML}
                ${anotacoesHTML}
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-4 italic">Pesquisa de: ${autor || 'Anônimo'}</p>
            `;

            if (anotacoes && anotacoes.length > MAX_LENGTH) {
                const toggleBtn = card.querySelector(`#${toggleBtnId}`);
                const anotacoesP = card.querySelector(`#${anotacoesId}`);
                let isTruncated = true;

                toggleBtn.addEventListener('click', () => {
                    isTruncated = !isTruncated;
                    if (isTruncated) {
                        anotacoesP.textContent = anotacoes.substring(0, MAX_LENGTH) + '...';
                        toggleBtn.textContent = 'Mostrar tudo';
                    } else {
                        anotacoesP.textContent = anotacoes;
                        toggleBtn.textContent = 'Mostrar menos';
                    }
                });
            }

            return card;
        }

        async function mostrarConteudo(nomeLivro, numCapitulo) {
            estadoAtual.livro = nomeLivro;
            estadoAtual.capitulo = numCapitulo;
            esconderTudo();
            views.conteudo.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-conteudo').textContent = `${nomeLivro} ${numCapitulo}`;
            const container = document.getElementById('destaques-container');
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Carregando destaques...</p>';

            try {
                const q = query(collection(db, destaquesCollectionPath), where("livro", "==", nomeLivro), where("capitulo", "==", numCapitulo));
                const querySnapshot = await getDocs(q);
                const destaquesDoCapitulo = [];
                querySnapshot.forEach((doc) => destaquesDoCapitulo.push({ id: doc.id, ...doc.data() }));

                destaquesDoCapitulo.sort((a, b) => {
                    const firstNumA = parseInt(String(a.versiculo).split(/[,-]/)[0], 10);
                    const firstNumB = parseInt(String(b.versiculo).split(/[,-]/)[0], 10);
                    return firstNumA - firstNumB;
                });

                container.innerHTML = '';
                if (destaquesDoCapitulo.length > 0) {
                    destaquesDoCapitulo.forEach(destaque => {
                        const card = criarCardDestaque(destaque);
                        card.querySelector('.copy-btn').addEventListener('click', () => {
                            const textoParaCopiar = `${destaque.livro} ${destaque.capitulo}:${destaque.versiculo}\n\n${destaque.texto}`;
                            copiarTexto(textoParaCopiar);
                        });
                        card.querySelector('.edit-btn').addEventListener('click', () => iniciarAcao('edit', destaque.id, 'destaques'));
                        card.querySelector('.delete-btn').addEventListener('click', () => iniciarAcao('delete', destaque.id, 'destaques'));
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Nenhum destaque salvo para este capítulo.</p>';
                }
            } catch(e) {
                console.error("Erro ao buscar destaques: ", e);
                container.innerHTML = '<p class="text-red-500">Ocorreu um erro ao carregar os destaques.</p>';
            }
        }
        
        async function realizarPesquisa(event) {
            event.preventDefault();
            const termo = document.getElementById('input-pesquisa').value.toLowerCase();
            const container = document.getElementById('container-resultados');
            const searchTypeJoias = document.getElementById('search-type-joias');
            const isPesquisas = !searchTypeJoias.classList.contains('active');

            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Pesquisando...</p>';

            if (!termo) {
                container.innerHTML = '';
                return;
            }

            try {
                const collectionPath = isPesquisas ? pesquisasCollectionPath : destaquesCollectionPath;
                const querySnapshot = await getDocs(collection(db, collectionPath));
                const todosItens = [];
                querySnapshot.forEach((doc) => {
                    todosItens.push({ id: doc.id, ...doc.data() });
                });

                const resultados = todosItens.filter(item => {
                    if(isPesquisas) {
                        const titulo = item.titulo ? item.titulo.toLowerCase() : '';
                        const anotacoes = item.anotacoes ? item.anotacoes.toLowerCase() : '';
                        const tags = item.tags ? item.tags.join(' ').toLowerCase() : '';
                        return titulo.includes(termo) || anotacoes.includes(termo) || tags.includes(termo);
                    } else {
                        const texto = item.texto ? item.texto.toLowerCase() : '';
                        const autor = item.autor ? item.autor.toLowerCase() : '';
                        return texto.includes(termo) || autor.includes(termo);
                    }
                });

                container.innerHTML = '';
                if (resultados.length > 0) {
                    resultados.forEach(item => {
                        const card = isPesquisas ? criarCardPesquisa(item) : criarCardDestaque(item);
                        card.querySelector('.copy-btn').addEventListener('click', () => {
                            let textoParaCopiar = '';
                            if (isPesquisas) {
                                textoParaCopiar = `${item.titulo}\n\n`;
                                if (item.textoBiblico) {
                                    textoParaCopiar += `Texto Bíblico:\n${item.textoBiblico}\n\n`;
                                }
                                textoParaCopiar += `Anotações:\n${item.anotacoes}`;
                            } else {
                                textoParaCopiar = `${item.livro} ${item.capitulo}:${item.versiculo}\n\n${item.texto}`;
                            }
                            copiarTexto(textoParaCopiar);
                        });
                        card.querySelector('.edit-btn').addEventListener('click', () => iniciarAcao('edit', item.id, isPesquisas ? 'pesquisas' : 'destaques'));
                        card.querySelector('.delete-btn').addEventListener('click', () => iniciarAcao('delete', item.id, isPesquisas ? 'pesquisas' : 'destaques'));
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhum resultado encontrado para "${termo}".</p>`;
                }

            } catch(e) {
                console.error("Erro ao pesquisar: ", e);
                container.innerHTML = `<p class="text-red-500">Ocorreu um erro ao realizar a pesquisa.</p>`;
            }
        }

        function mudarAba(abaAtiva) {
            esconderTudo();
            Object.values(tabs).forEach(tab => tab.classList.replace('tab-active', 'tab-inactive'));
            
            if (abaAtiva === 'livros') {
                views.livros.classList.remove('hidden');
                tabs.livros.classList.replace('tab-inactive', 'tab-active');
                popularLivros();
            } else if (abaAtiva === 'adicionarDestaque') {
                views.adicionarDestaque.classList.remove('hidden');
                tabs.adicionarDestaque.classList.replace('tab-inactive', 'tab-active');
            } else if (abaAtiva === 'pesquisar') {
                views.pesquisar.classList.remove('hidden');
                tabs.pesquisar.classList.replace('tab-inactive', 'tab-active');
            } else if (abaAtiva === 'pesquisas') {
                views.pesquisas.classList.remove('hidden');
                tabs.pesquisas.classList.replace('tab-inactive', 'tab-active');
                mostrarPesquisas();
            } else if (abaAtiva === 'adicionarPesquisa') {
                views.adicionarPesquisa.classList.remove('hidden');
                tabs.adicionarPesquisa.classList.replace('tab-inactive', 'tab-active');
            }
        }
        
        function iniciarAcao(type, docId, collection) {
            acaoPendente = { type, docId, collection };
            const title = type === 'delete' ? 'Confirmar Exclusão' : 'Acessar Edição';
            document.getElementById('password-modal-title').textContent = title;
            passwordModal.classList.remove('hidden');
        }

        function fecharModalSenha() {
            passwordModal.classList.add('hidden');
            document.getElementById('password-input').value = '';
            passwordError.classList.add('hidden');
            acaoPendente = { type: null, docId: null, collection: null };
        }

        async function confirmarSenha() {
            const password = document.getElementById('password-input').value;
            if (password === 'xetays2468') {
                const { type, docId, collection } = acaoPendente;
                fecharModalSenha();
                if (type === 'delete') {
                    const collectionPath = collection === 'destaques' ? destaquesCollectionPath : pesquisasCollectionPath;
                    deletarItem(docId, collectionPath);
                } else if (type === 'edit') {
                    abrirFormularioEdicao(docId, collection);
                }
            } else {
                passwordError.classList.remove('hidden');
            }
        }
        
        async function abrirFormularioEdicao(docId, collection) {
            const collectionPath = collection === 'destaques' ? destaquesCollectionPath : pesquisasCollectionPath;
            const formEdit = document.getElementById('form-edit');
            const modalTitle = document.getElementById('edit-modal-title');
            formEdit.innerHTML = ''; // Limpa o formulário anterior

            try {
                const docRef = doc(db, collectionPath, docId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showToast("Documento não encontrado.", false);
                    return;
                }

                const data = docSnap.data();
                let formHTML = '';

                if (collection === 'destaques') {
                    modalTitle.textContent = 'Editar Joia';
                    formHTML = `
                        <input type="hidden" name="docId" value="${docId}">
                        <input type="hidden" name="collection" value="destaques">
                        <div>
                            <label for="edit-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                            <input type="text" id="edit-autor" name="autor" value="${data.autor || ''}" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-versiculo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Versículo(s)</label>
                            <input type="text" id="edit-versiculo" name="versiculo" value="${data.versiculo || ''}" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-texto" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Joia</label>
                            <textarea id="edit-texto" name="texto" rows="6" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>${data.texto || ''}</textarea>
                        </div>
                    `;
                } else { // collection === 'pesquisas'
                    modalTitle.textContent = 'Editar Pesquisa';
                    formHTML = `
                        <input type="hidden" name="docId" value="${docId}">
                        <input type="hidden" name="collection" value="pesquisas">
                        <div>
                            <label for="edit-pesquisa-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                            <input type="text" id="edit-pesquisa-autor" name="autor" value="${data.autor || ''}" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-pesquisa-titulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Título</label>
                            <input type="text" id="edit-pesquisa-titulo" name="titulo" value="${data.titulo || ''}" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="edit-pesquisa-tags" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tags</label>
                            <input type="text" id="edit-pesquisa-tags" name="tags" value="${(data.tags || []).join(', ')}" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="edit-pesquisa-texto-biblico" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Texto Bíblico</label>
                            <textarea id="edit-pesquisa-texto-biblico" name="textoBiblico" rows="3" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">${data.textoBiblico || ''}</textarea>
                        </div>
                         <div>
                            <label for="edit-pesquisa-anotacoes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Anotações</label>
                            <textarea id="edit-pesquisa-anotacoes" name="anotacoes" rows="8" class="mt-1 block w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>${data.anotacoes || ''}</textarea>
                        </div>
                    `;
                }

                formHTML += `
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Salvar Alterações</button>
                    </div>
                `;

                formEdit.innerHTML = formHTML;
                document.getElementById('cancel-edit-btn').addEventListener('click', fecharFormularioEdicao);
                editModal.classList.remove('hidden');

            } catch (error) {
                console.error("Erro ao abrir formulário de edição:", error);
                showToast("Erro ao carregar dados para edição.", false);
            }
        }

        function fecharFormularioEdicao() {
            editModal.classList.add('hidden');
            document.getElementById('form-edit').innerHTML = '';
        }

        async function salvarEdicao(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const docId = formData.get('docId');
            const collection = formData.get('collection');
            const collectionPath = collection === 'destaques' ? destaquesCollectionPath : pesquisasCollectionPath;
            
            let updatedData = {};

            if (collection === 'destaques') {
                updatedData = {
                    autor: formData.get('autor'),
                    versiculo: formData.get('versiculo'),
                    texto: formData.get('texto')
                };
            } else { // pesquisas
                updatedData = {
                    autor: formData.get('autor'),
                    titulo: formData.get('titulo'),
                    tags: formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag),
                    textoBiblico: formData.get('textoBiblico'),
                    anotacoes: formData.get('anotacoes')
                };
            }

            try {
                const docRef = doc(db, collectionPath, docId);
                await updateDoc(docRef, updatedData);
                showToast("Atualizado com sucesso!");
                fecharFormularioEdicao();

                // Refresh the view
                if (collection === 'destaques') {
                    if (!views.conteudo.classList.contains('hidden')) {
                        mostrarConteudo(estadoAtual.livro, estadoAtual.capitulo);
                    } else if (!views.pesquisar.classList.contains('hidden')) {
                        formPesquisa.dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                } else { // pesquisas
                     if (!views.pesquisas.classList.contains('hidden')) {
                        mostrarPesquisas();
                    } else if (!views.pesquisar.classList.contains('hidden')) {
                         formPesquisa.dispatchEvent(new Event('submit', { cancelable: true }));
                    }
                }
            } catch (error) {
                console.error("Erro ao salvar edição:", error);
                showToast("Falha ao salvar as alterações.", false);
            }
        }
        
        async function mostrarPesquisas() {
            const container = document.getElementById('container-pesquisas');
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">A carregar pesquisas...</p>';
            try {
                const querySnapshot = await getDocs(collection(db, pesquisasCollectionPath));
                const pesquisas = [];
                querySnapshot.forEach((doc) => {
                    pesquisas.push({ id: doc.id, ...doc.data() });
                });

                container.innerHTML = '';
                if (pesquisas.length > 0) {
                    // Ordena as pesquisas pela data de criação, da mais recente para a mais antiga
                    pesquisas.sort((a, b) => {
                        const dateA = a.createdAt && a.createdAt.toDate ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    
                    pesquisas.forEach(pesquisa => {
                        const card = criarCardPesquisa(pesquisa);
                        card.querySelector('.copy-btn').addEventListener('click', () => {
                            let textoParaCopiar = `${pesquisa.titulo}\n\n`;
                            if (pesquisa.textoBiblico) {
                                textoParaCopiar += `Texto Bíblico:\n${pesquisa.textoBiblico}\n\n`;
                            }
                            textoParaCopiar += `Anotações:\n${pesquisa.anotacoes}`;
                            copiarTexto(textoParaCopiar);
                        });
                        card.querySelector('.edit-btn').addEventListener('click', () => iniciarAcao('edit', pesquisa.id, 'pesquisas'));
                        card.querySelector('.delete-btn').addEventListener('click', () => iniciarAcao('delete', pesquisa.id, 'pesquisas'));
                        container.appendChild(card);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Nenhuma pesquisa salva ainda.</p>';
                }
            } catch (e) {
                console.error("Erro ao buscar pesquisas: ", e);
                container.innerHTML = '<p class="text-red-500">Ocorreu um erro ao carregar as pesquisas.</p>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('theme-toggle-sun');
            const moonIcon = document.getElementById('theme-toggle-moon');
            const notificationBell = document.getElementById('notification-bell');
            const notificationPanel = document.getElementById('notification-panel');
            const notificationCount = document.getElementById('notification-count');
            const notificationList = document.getElementById('notification-list');

            let unreadCount = 0;
            let allNotifications = [];

            function updateNotificationUI() {
                notificationCount.textContent = unreadCount;
                if (unreadCount > 0) {
                    notificationCount.classList.remove('hidden');
                } else {
                    notificationCount.classList.add('hidden');
                }
                renderNotificationsList();
            }

            function renderNotificationsList() {
                notificationList.innerHTML = '';
                if (allNotifications.length === 0) {
                    notificationList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 p-4 text-center">Nenhuma notificação recente.</p>';
                    return;
                }
                allNotifications.forEach(notif => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700';
                    if (notif.type === 'joia') {
                        item.innerHTML = `<p class="font-bold">Nova joia de: ${notif.data.autor}</p><p>Em ${notif.data.livro} ${notif.data.capitulo}:${notif.data.versiculo}</p>`;
                        item.onclick = (e) => {
                            e.preventDefault();
                            mostrarConteudo(notif.data.livro, notif.data.capitulo);
                            notificationPanel.classList.add('hidden');
                        };
                    } else { // pesquisa
                        item.innerHTML = `<p class="font-bold">Nova pesquisa de: ${notif.data.autor}</p><p>${notif.data.titulo}</p>`;
                        item.onclick = (e) => {
                            e.preventDefault();
                            mudarAba('pesquisas');
                            notificationPanel.classList.add('hidden');
                        };
                    }
                    notificationList.appendChild(item);
                });
            }

            function setupNotificationListener() {
                const lastViewed = localStorage.getItem('lastViewedNotification') || 0;
                
                const processChanges = (snapshot, type) => {
                    let newNotifications = false;
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const docData = change.doc.data();
                            const docTimestamp = docData.createdAt.toMillis();
                            
                            allNotifications.unshift({
                                type: type,
                                data: docData,
                                id: change.doc.id,
                                timestamp: docTimestamp
                            });

                            if (docTimestamp > lastViewed) {
                                unreadCount++;
                                newNotifications = true;
                            }
                        }
                    });
                    
                    allNotifications.sort((a, b) => b.timestamp - a.timestamp);
                    if(allNotifications.length > 10) allNotifications.length = 10; // Limita a 10 notificações

                    if(newNotifications) updateNotificationUI();
                };

                const qJoias = query(collection(db, destaquesCollectionPath), orderBy("createdAt", "desc"), limit(5));
                onSnapshot(qJoias, (snapshot) => processChanges(snapshot, 'joia'));

                const qPesquisas = query(collection(db, pesquisasCollectionPath), orderBy("createdAt", "desc"), limit(5));
                onSnapshot(qPesquisas, (snapshot) => processChanges(snapshot, 'pesquisa'));
            }

            notificationBell.addEventListener('click', () => {
                notificationPanel.classList.toggle('hidden');
                if (!notificationPanel.classList.contains('hidden')) {
                    unreadCount = 0;
                    localStorage.setItem('lastViewedNotification', Date.now());
                    updateNotificationUI();
                }
            });

            function setTema(isDark) {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            popularLivros();
            popularSelectLivros();
            setupNotificationListener();

            formDestaque.addEventListener('submit', salvarDestaque);
            formPesquisa.addEventListener('submit', realizarPesquisa);
            formAdicionarPesquisa.addEventListener('submit', salvarPesquisa);
            document.getElementById('form-edit').addEventListener('submit', salvarEdicao);
            
            tabs.livros.addEventListener('click', (e) => { e.preventDefault(); mudarAba('livros'); });
            tabs.adicionarDestaque.addEventListener('click', (e) => { e.preventDefault(); mudarAba('adicionarDestaque'); });
            tabs.pesquisar.addEventListener('click', (e) => { e.preventDefault(); mudarAba('pesquisar'); });
            tabs.pesquisas.addEventListener('click', (e) => { e.preventDefault(); mudarAba('pesquisas'); });
            tabs.adicionarPesquisa.addEventListener('click', (e) => { e.preventDefault(); mudarAba('adicionarPesquisa'); });
            
            document.getElementById('btn-voltar-livros').addEventListener('click', () => mudarAba('livros'));
            document.getElementById('btn-voltar-capitulos').addEventListener('click', () => {
                const livro = estadoAtual.livro;
                const numCapitulos = biblia["Antigo Testamento"][livro] || biblia["Novo Testamento"][livro];
                mostrarCapitulos(livro, numCapitulos);
            });
            
            // Event Listeners dos Modais
            document.getElementById('cancel-password-btn').addEventListener('click', fecharModalSenha);
            document.getElementById('confirm-password-btn').addEventListener('click', confirmarSenha);
            passwordModal.addEventListener('click', (e) => {
                if (e.target === passwordModal) fecharModalSenha();
            });
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) fecharFormularioEdicao();
            });

            // Lógica do Tema
            const temaSalvo = localStorage.getItem('theme');
            const prefereEscuro = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const ehEscuro = temaSalvo === 'dark' || (temaSalvo === null && prefereEscuro);
            setTema(ehEscuro);

            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                setTema(!isDark);
            });

            selectLivro.addEventListener('change', () => {
                const nomeLivro = selectLivro.value;
                const todosLivros = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
                const numCapitulos = todosLivros[nomeLivro];

                selectCapitulo.innerHTML = ''; // Limpa opções anteriores

                if (numCapitulos) {
                    selectCapitulo.disabled = false;
                    selectCapitulo.innerHTML = '<option value="" disabled selected>Selecione</option>';
                    for (let i = 1; i <= numCapitulos; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        selectCapitulo.appendChild(option);
                    }
                } else {
                    selectCapitulo.disabled = true;
                    selectCapitulo.innerHTML = '<option value="">Selecione o livro</option>';
                }
            });

            // Lógica do seletor de pesquisa
            const searchTypeJoias = document.getElementById('search-type-joias');
            const searchTypePesquisas = document.getElementById('search-type-pesquisas');

            searchTypeJoias.addEventListener('click', () => {
                searchTypeJoias.classList.add('active');
                searchTypePesquisas.classList.remove('active');
            });

            searchTypePesquisas.addEventListener('click', () => {
                searchTypePesquisas.classList.add('active');
                searchTypeJoias.classList.remove('active');
            });
        });
    </script>
</body>
</html>

