<!DOCTYPE html>
<html lang="pt-br" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joias Espirituais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configura o Tailwind CSS para usar a estratégia de 'class' para o modo escuro.
        // Isto é essencial para que o botão de alternância de tema funcione.
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-custom-blue {
            background-color: #4a6da7;
        }
        .hover\:bg-custom-blue-dark:hover {
            background-color: #3e5a8a;
        }
        .tab-active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        .dark .tab-active {
            color: #60a5fa; /* text-blue-400 */
            border-bottom-color: #60a5fa;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .dark .tab-inactive {
            color: #9ca3af; /* text-gray-400 */
        }
        .tab-inactive:hover {
            color: #2563eb;
        }
        .dark .tab-inactive:hover {
            color: #60a5fa;
        }
        /* Estilos para a notificação (Toast) */
        .toast {
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        /* Estilo para capítulo com destaque */
        .has-highlight {
            background-color: #4a6da7;
            color: white;
            border-color: #3e5a8a;
        }
        .has-highlight:hover {
            background-color: #3e5a8a;
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-2 sm:p-6 md:p-8 max-w-6xl">
        <div class="bg-white dark:bg-gray-800 shadow-md min-h-screen rounded-lg">

            <!-- Navegação com Abas -->
            <nav class="border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10 rounded-t-lg">
                <div class="px-4 sm:px-8 py-3 flex justify-center sm:justify-start space-x-6 sm:space-x-8">
                    <a href="#" id="tab-livros" class="text-sm font-semibold pb-3 tab-active flex items-center">
                        <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 1.25l-7.5 7.5 7.5 7.5 7.5-7.5-7.5-7.5z"></path></svg>
                        DESTAQUES
                    </a>
                    <a href="#" id="tab-destaques" class="text-sm font-semibold pb-3 tab-inactive flex items-center">ADICIONAR DESTAQUES</a>
                    <a href="#" id="tab-pesquisar" class="text-sm font-semibold pb-3 tab-inactive flex items-center">PESQUISAR</a>
                </div>
            </nav>

            <!-- Visualização dos Livros -->
            <main id="view-livros">
                <div class="p-4 sm:p-8 space-y-8">
                    <section id="antigo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 dark:text-gray-400 mb-4">ESCRITURAS HEBRAICO-ARAMAICAS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></div>
                    </section>
                    <section id="novo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 dark:text-gray-400 mb-4">ESCRITURAS GREGAS CRISTÃS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 dark:bg-gray-700 border border-gray-300 dark:border-gray-600"></div>
                    </section>
                </div>
            </main>
            
            <!-- Visualização Adicionar Destaques -->
            <div id="view-destaques" class="hidden p-4 sm:p-8 flex flex-col items-center">
                <div class="w-full max-w-lg">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Adicionar Destaque</h2>
                    <form id="form-destaque" class="space-y-4">
                        <fieldset>
                            <div>
                                <label for="input-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                                <input type="text" id="input-autor" name="autor" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="select-livro" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Livro</label>
                                <select id="select-livro" name="livro" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required></select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="select-capitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Capítulo</label>
                                    <select id="select-capitulo" name="capitulo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required disabled>
                                        <option value="">Selecione o livro</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="input-versiculo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Versículo(s)</label>
                                    <input type="text" id="input-versiculo" name="versiculo" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 5 ou 5,6 ou 5-7" required>
                                </div>
                            </div>
                            <div>
                                <label for="textarea-destaque" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Destaque</label>
                                <textarea id="textarea-destaque" name="destaque" rows="4" class="mt-1 block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            </div>
                            <div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Salvar Destaque</button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>

            <!-- Visualização de Pesquisa -->
            <div id="view-pesquisar" class="hidden p-4 sm:p-8 flex flex-col items-center">
                 <div class="w-full max-w-2xl">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Pesquisar Destaques</h2>
                    <form id="form-pesquisa" class="flex gap-2 mb-8">
                        <input type="search" id="input-pesquisa" class="block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Digite uma palavra-chave...">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Buscar</button>
                    </form>
                    <div id="container-resultados" class="space-y-4">
                        <!-- Resultados da pesquisa aparecerão aqui -->
                    </div>
                </div>
            </div>

            <!-- Visualização dos Capítulos (Grid de números) -->
            <div id="view-capitulos" class="hidden">
                 <header class="p-4 sm:p-6 border-b dark:border-gray-700">
                    <button id="btn-voltar-livros" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mb-6">&larr; Voltar para Livros</button>
                    <h1 id="titulo-livro-capitulos" class="text-3xl font-bold text-slate-800 dark:text-slate-100"></h1>
                </header>
                <div class="p-4 sm:p-8">
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Capítulos</h3>
                    <div id="grid-capitulos" class="grid grid-cols-5 sm:grid-cols-8 md:grid-cols-12 gap-2"></div>
                </div>
            </div>

            <!-- Visualização do Conteúdo do Capítulo (com destaques) -->
            <div id="view-conteudo" class="hidden">
                <header class="p-4 sm:p-6 border-b dark:border-gray-700">
                    <button id="btn-voltar-capitulos" class="text-blue-600 dark:text-blue-400 hover:underline text-sm mb-6">&larr; Voltar para Capítulos</button>
                    <h1 id="titulo-conteudo" class="text-3xl font-bold text-slate-800 dark:text-slate-100"></h1>
                </header>
                <div id="destaques-container" class="p-4 sm:p-8 space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Container para as notificações (Toasts) -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <!-- Modal de Senha -->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 modal-overlay">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <h3 id="password-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Para continuar, por favor, insira a senha.</p>
                    <input type="password" id="password-input" placeholder="Senha" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Senha incorreta.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="cancel-password-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 mr-2">Cancelar</button>
                    <button id="confirm-password-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 modal-overlay">
         <div class="relative top-10 mx-auto p-5 border border-gray-200 dark:border-gray-700 w-11/12 max-w-lg shadow-lg rounded-md bg-white dark:bg-gray-800">
             <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Editar Destaque</h2>
             <form id="form-edit" class="space-y-4">
                 <!-- Campos do formulário de edição serão preenchidos via JS -->
             </form>
         </div>
    </div>

    <!-- Botão de Tema (Sol/Lua) -->
    <button id="theme-toggle" class="fixed bottom-5 right-5 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full p-3 shadow-lg focus:outline-none">
        <svg id="theme-toggle-sun" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414z"></path></svg>
        <svg id="theme-toggle-moon" class="hidden w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
    </button>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, setLogLevel, doc, deleteDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAKG3DUkXfs1DzkJqK9gNW3NbBsQUmtYVo",
            authDomain: "destaques-627c7.firebaseapp.com",
            projectId: "destaques-627c7",
            storageBucket: "destaques-627c7.firebasestorage.app",
            messagingSenderId: "748367852239",
            appId: "1:748367852239:web:ef84cffe6355e87392bdba",
            measurementId: "G-1LRM7D0MY1"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId || 'default-app-id';
        setLogLevel('debug');

        let acaoPendente = { type: null, docId: null };
        const publicCollectionPath = `/artifacts/${appId}/public/data/destaques`;

        const biblia = {
            "Antigo Testamento": {"Gênesis": 50, "Êxodo": 40, "Levítico": 27, "Números": 36, "Deuteronômio": 34, "Josué": 24, "Juízes": 21, "Rute": 4, "1 Samuel": 31, "2 Samuel": 24, "1 Reis": 22, "2 Reis": 25, "1 Crônicas": 29, "2 Crônicas": 36, "Esdras": 10, "Neemias": 13, "Ester": 10, "Jó": 42, "Salmos": 150, "Provérbios": 31, "Eclesiastes": 12, "Cântico de Salomão": 8, "Isaías": 66, "Jeremias": 52, "Lamentações": 5, "Ezequiel": 48, "Daniel": 12, "Oseias": 14, "Joel": 3, "Amós": 9, "Obadias": 1, "Jonas": 4, "Miqueias": 7, "Naum": 3, "Habacuque": 3, "Sofonias": 3, "Ageu": 2, "Zacarias": 14, "Malaquias": 4},
            "Novo Testamento": {"Mateus": 28, "Marcos": 16, "Lucas": 24, "João": 21, "Atos": 28, "Romanos": 16, "1 Coríntios": 16, "2 Coríntios": 13, "Gálatas": 6, "Efésios": 6, "Filipenses": 4, "Colossenses": 4, "1 Tessalonicenses": 5, "2 Tessalonicenses": 3, "1 Timóteo": 6, "2 Timóteo": 4, "Tito": 3, "Filemom": 1, "Hebreus": 13, "Tiago": 5, "1 Pedro": 5, "2 Pedro": 3, "1 João": 5, "2 João": 1, "3 João": 1, "Judas": 1, "Apocalipse": 22}
        };
        
        let estadoAtual = { livro: null, capitulo: null };

        const views = {
            livros: document.getElementById('view-livros'),
            destaques: document.getElementById('view-destaques'),
            pesquisar: document.getElementById('view-pesquisar'),
            capitulos: document.getElementById('view-capitulos'),
            conteudo: document.getElementById('view-conteudo'),
        };
        const tabs = {
            livros: document.getElementById('tab-livros'),
            destaques: document.getElementById('tab-destaques'),
            pesquisar: document.getElementById('tab-pesquisar'),
        };
        const formDestaque = document.getElementById('form-destaque');
        const formPesquisa = document.getElementById('form-pesquisa');
        const selectLivro = document.getElementById('select-livro');
        const selectCapitulo = document.getElementById('select-capitulo');
        const passwordModal = document.getElementById('password-modal');
        const editModal = document.getElementById('edit-modal');
        const passwordError = document.getElementById('password-error');
        
        function showToast(message, isSuccess = true) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = isSuccess ? 'bg-green-500' : 'bg-red-500';
            toast.className = `toast text-white p-4 rounded-md shadow-lg flex items-center justify-between ${bgColor}`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            toast.appendChild(messageSpan);

            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function esconderTudo() { Object.values(views).forEach(view => view.classList.add('hidden')); }

        function popularSelectLivros() {
            selectLivro.innerHTML = '<option value="" disabled selected>Selecione um livro</option>';
            const todosLivros = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
            Object.keys(todosLivros).forEach(livro => {
                const option = document.createElement('option');
                option.value = livro;
                option.textContent = livro;
                selectLivro.appendChild(option);
            });
        }

        async function salvarDestaque(event) {
            event.preventDefault();
            const formData = new FormData(formDestaque);
            const destaqueData = {
                autor: formData.get('autor'),
                livro: formData.get('livro'),
                capitulo: parseInt(formData.get('capitulo'), 10),
                versiculo: formData.get('versiculo'),
                texto: formData.get('destaque'),
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, publicCollectionPath), destaqueData);
                showToast("Destaque salvo com sucesso!");
                formDestaque.reset();
                selectCapitulo.disabled = true;
                selectCapitulo.innerHTML = '<option value="">Selecione o livro</option>';
                popularLivros();
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showToast("Falha ao salvar o destaque.", false);
            }
        }

        async function popularLivros() {
            const containerAntigo = document.querySelector('#antigo-testamento .grid');
            const containerNovo = document.querySelector('#novo-testamento .grid');
            containerAntigo.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Carregando livros...</p>';
            containerNovo.innerHTML = '';

            const livrosComDestaque = new Set();
            try {
                const querySnapshot = await getDocs(collection(db, publicCollectionPath));
                querySnapshot.forEach((doc) => {
                    livrosComDestaque.add(doc.data().livro);
                });
            } catch(e) {
                console.error("Erro ao buscar destaques dos livros: ", e);
                showToast("Não foi possível verificar os destaques dos livros.", false);
            }

            containerAntigo.innerHTML = '';
            containerNovo.innerHTML = '';

            const criarBotao = (nome, caps, temDestaque) => {
                const div = document.createElement('div');
                div.textContent = nome;
                let classes = 'font-medium p-4 text-center cursor-pointer transition-colors duration-200';
                if (temDestaque) {
                    classes += ' bg-custom-blue hover:bg-custom-blue-dark text-white';
                } else {
                    classes += ' bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200';
                }
                div.className = classes;
                div.onclick = () => mostrarCapitulos(nome, caps);
                return div;
            };

            Object.entries(biblia["Antigo Testamento"]).forEach(([livro, caps]) => {
                containerAntigo.appendChild(criarBotao(livro, caps, livrosComDestaque.has(livro)));
            });
            Object.entries(biblia["Novo Testamento"]).forEach(([livro, caps]) => {
                containerNovo.appendChild(criarBotao(livro, caps, livrosComDestaque.has(livro)));
            });
        }

        async function mostrarCapitulos(nomeLivro, numCapitulos) {
            estadoAtual.livro = nomeLivro;
            esconderTudo();
            views.capitulos.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-livro-capitulos').textContent = `O Livro de ${nomeLivro}`;
            const grid = document.getElementById('grid-capitulos');
            grid.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full">Verificando destaques...</p>';

            const capitulosComDestaque = new Set();
            try {
                const q = query(collection(db, publicCollectionPath), where("livro", "==", nomeLivro));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    capitulosComDestaque.add(doc.data().capitulo);
                });
            } catch (e) {
                console.error("Erro ao verificar destaques: ", e);
                showToast("Erro ao verificar destaques.", false);
            }

            grid.innerHTML = '';

            for (let i = 1; i <= numCapitulos; i++) {
                const capButton = document.createElement('button');
                capButton.textContent = i;
                let classes = 'border rounded-sm p-2 text-center focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200';
                
                if (capitulosComDestaque.has(i)) {
                    classes += ' has-highlight';
                } else {
                    classes += ' border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700';
                }
                
                capButton.className = classes;
                capButton.onclick = () => mostrarConteudo(nomeLivro, i);
                grid.appendChild(capButton);
            }
        }
        
        async function deletarDestaque(docId) {
            if (!docId) {
                showToast("Erro ao deletar: ID do documento ausente.", false);
                return;
            }
            try {
                await deleteDoc(doc(db, publicCollectionPath, docId));
                showToast("Destaque removido.");
                if (document.getElementById('view-conteudo').classList.contains('hidden')) {
                    document.getElementById('form-pesquisa').requestSubmit();
                } else {
                    await mostrarConteudo(estadoAtual.livro, estadoAtual.capitulo);
                }
                popularLivros();
            } catch (error) {
                console.error("Erro ao deletar destaque: ", error);
                showToast("Falha ao remover o destaque.", false);
            }
        }

        function criarCardDestaque(destaque) {
            const { id, versiculo, texto, autor, livro, capitulo } = destaque;
            const card = document.createElement('div');
            card.className = 'relative border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50';
            
            const isSearchView = !document.getElementById('view-pesquisar').classList.contains('hidden');
            const referencia = isSearchView ? `<p class="font-semibold text-gray-600 dark:text-gray-300 text-sm mb-2">${livro} ${capitulo}</p>` : '';

            card.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-bold text-blue-600 dark:text-blue-400">Versículo(s) ${versiculo}</p>
                    <div class="flex">
                        <button data-doc-id="${id}" class="edit-btn text-gray-400 hover:text-blue-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button data-doc-id="${id}" class="delete-btn text-gray-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div>
                    ${referencia}
                    <p class="mt-2 text-gray-700 dark:text-gray-300 whitespace-pre-wrap">${texto}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 italic">Destaque de: ${autor || 'Anônimo'}</p>
                </div>
            `;
            return card;
        }

        async function mostrarConteudo(nomeLivro, numCapitulo) {
            estadoAtual.livro = nomeLivro;
            estadoAtual.capitulo = numCapitulo;
            esconderTudo();
            views.conteudo.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-conteudo').textContent = `${nomeLivro} ${numCapitulo}`;
            const container = document.getElementById('destaques-container');
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Carregando destaques...</p>';

            try {
                const q = query(collection(db, publicCollectionPath), where("livro", "==", nomeLivro), where("capitulo", "==", numCapitulo));
                const querySnapshot = await getDocs(q);
                const destaquesDoCapitulo = [];
                querySnapshot.forEach((doc) => destaquesDoCapitulo.push({ id: doc.id, ...doc.data() }));

                destaquesDoCapitulo.sort((a, b) => {
                    const firstNumA = parseInt(String(a.versiculo).split(/[,-]/)[0], 10);
                    const firstNumB = parseInt(String(b.versiculo).split(/[,-]/)[0], 10);
                    return firstNumA - firstNumB;
                });

                container.innerHTML = '';
                if (destaquesDoCapitulo.length > 0) {
                    destaquesDoCapitulo.forEach(destaque => {
                        const card = criarCardDestaque(destaque);
                        container.appendChild(card);
                    });
                    container.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => iniciarAcao('delete', b.dataset.docId)));
                    container.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => iniciarAcao('edit', b.dataset.docId)));
                } else {
                    container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Nenhum destaque salvo para este capítulo.</p>';
                }
            } catch(e) {
                console.error("Erro ao buscar destaques: ", e);
                container.innerHTML = '<p class="text-red-500">Ocorreu um erro ao carregar os destaques.</p>';
            }
        }
        
        async function pesquisarDestaques(event) {
            event.preventDefault();
            const termo = document.getElementById('input-pesquisa').value.toLowerCase();
            const container = document.getElementById('container-resultados');
            container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Pesquisando...</p>';

            if (!termo) {
                container.innerHTML = '';
                return;
            }

            try {
                const querySnapshot = await getDocs(collection(db, publicCollectionPath));
                const todosDestaques = [];
                querySnapshot.forEach((doc) => {
                    todosDestaques.push({ id: doc.id, ...doc.data() });
                });

                const resultados = todosDestaques.filter(d => {
                    const texto = d.texto ? d.texto.toLowerCase() : '';
                    const autor = d.autor ? d.autor.toLowerCase() : '';
                    return texto.includes(termo) || autor.includes(termo);
                });

                container.innerHTML = '';
                if (resultados.length > 0) {
                    resultados.forEach(destaque => {
                         const card = criarCardDestaque(destaque);
                         container.appendChild(card);
                    });
                    container.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => iniciarAcao('delete', b.dataset.docId)));
                    container.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => iniciarAcao('edit', b.dataset.docId)));
                } else {
                    container.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Nenhum resultado encontrado para "${termo}".</p>`;
                }

            } catch(e) {
                console.error("Erro ao pesquisar: ", e);
                container.innerHTML = `<p class="text-red-500">Ocorreu um erro ao realizar a pesquisa.</p>`;
            }
        }

        function mudarAba(abaAtiva) {
            esconderTudo();
            Object.values(tabs).forEach(tab => tab.classList.replace('tab-active', 'tab-inactive'));
            if (abaAtiva === 'livros') {
                views.livros.classList.remove('hidden');
                tabs.livros.classList.replace('tab-inactive', 'tab-active');
                popularLivros();
            } else if (abaAtiva === 'destaques') {
                views.destaques.classList.remove('hidden');
                tabs.destaques.classList.replace('tab-inactive', 'tab-active');
            } else if (abaAtiva === 'pesquisar') {
                views.pesquisar.classList.remove('hidden');
                tabs.pesquisar.classList.replace('tab-inactive', 'tab-active');
            }
        }
        
        function iniciarAcao(type, docId) {
            acaoPendente = { type, docId };
            const title = type === 'delete' ? 'Confirmar Exclusão' : 'Acessar Edição';
            document.getElementById('password-modal-title').textContent = title;
            passwordModal.classList.remove('hidden');
        }

        function fecharModalSenha() {
            passwordModal.classList.add('hidden');
            document.getElementById('password-input').value = '';
            passwordError.classList.add('hidden');
            acaoPendente = { type: null, docId: null };
        }

        async function confirmarSenha() {
            const password = document.getElementById('password-input').value;
            if (password === 'xetays2468') {
                const { type, docId } = acaoPendente;
                fecharModalSenha();
                if (type === 'delete') {
                    deletarDestaque(docId);
                } else if (type === 'edit') {
                    abrirFormularioEdicao(docId);
                }
            } else {
                passwordError.classList.remove('hidden');
            }
        }
        
        async function abrirFormularioEdicao(docId) {
            try {
                const docRef = doc(db, publicCollectionPath, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const form = document.getElementById('form-edit');
                    form.dataset.docId = docId;
                    form.innerHTML = `
                        <fieldset>
                            <div>
                                <label for="edit-autor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Seu Nome</label>
                                <input type="text" id="edit-autor" name="autor" value="${data.autor}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm py-2 px-3" required>
                            </div>
                             <div>
                                <label for="edit-livro" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Livro</label>
                                <input type="text" id="edit-livro" name="livro" value="${data.livro}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-gray-100 dark:bg-gray-900" readonly>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-capitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Capítulo</label>
                                    <input type="number" id="edit-capitulo" name="capitulo" value="${data.capitulo}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm py-2 px-3 bg-gray-100 dark:bg-gray-900" readonly>
                                </div>
                                <div>
                                    <label for="edit-versiculo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Versículo(s)</label>
                                    <input type="text" id="edit-versiculo" name="versiculo" value="${data.versiculo}" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm py-2 px-3" required>
                                </div>
                            </div>
                            <div>
                                <label for="edit-destaque" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Destaque</label>
                                <textarea id="edit-destaque" name="destaque" rows="4" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm py-2 px-3" required>${data.texto}</textarea>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                               <button type="button" id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500">Cancelar</button>
                               <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Atualizar Destaque</button>
                            </div>
                        </fieldset>
                    `;
                    editModal.classList.remove('hidden');
                    document.getElementById('cancel-edit-btn').addEventListener('click', fecharFormularioEdicao);
                } else {
                    showToast("Destaque não encontrado.", false);
                }
            } catch(e) {
                showToast("Erro ao carregar dados para edição.", false);
                console.error(e);
            }
        }

        function fecharFormularioEdicao() {
            editModal.classList.add('hidden');
            document.getElementById('form-edit').innerHTML = '';
        }

        async function salvarEdicao(event) {
            event.preventDefault();
            const form = event.target;
            const docId = form.dataset.docId;
            if (!docId) return;

            const dadosAtualizados = {
                autor: form.elements.autor.value,
                versiculo: form.elements.versiculo.value,
                texto: form.elements.destaque.value
            };

            try {
                const docRef = doc(db, publicCollectionPath, docId);
                await updateDoc(docRef, dadosAtualizados);
                showToast("Destaque atualizado com sucesso!");
                fecharFormularioEdicao();
                if (document.getElementById('view-conteudo').classList.contains('hidden')) {
                    document.getElementById('form-pesquisa').requestSubmit();
                } else {
                    await mostrarConteudo(estadoAtual.livro, estadoAtual.capitulo);
                }
            } catch(e) {
                showToast("Erro ao atualizar o destaque.", false);
                console.error(e);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('theme-toggle-sun');
            const moonIcon = document.getElementById('theme-toggle-moon');

            function setTema(isDark) {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                if (isDark) {
                    document.documentElement.classList.add('dark');
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }

            popularLivros();
            popularSelectLivros();

            formDestaque.addEventListener('submit', salvarDestaque);
            formPesquisa.addEventListener('submit', pesquisarDestaques);
            document.getElementById('form-edit').addEventListener('submit', salvarEdicao);
            
            tabs.livros.addEventListener('click', (e) => { e.preventDefault(); mudarAba('livros'); });
            tabs.destaques.addEventListener('click', (e) => { e.preventDefault(); mudarAba('destaques'); });
            tabs.pesquisar.addEventListener('click', (e) => { e.preventDefault(); mudarAba('pesquisar'); });
            
            document.getElementById('btn-voltar-livros').addEventListener('click', () => mudarAba('livros'));
            document.getElementById('btn-voltar-capitulos').addEventListener('click', () => {
                const livro = estadoAtual.livro;
                const numCapitulos = biblia["Antigo Testamento"][livro] || biblia["Novo Testamento"][livro];
                mostrarCapitulos(livro, numCapitulos);
            });
            
            // Event Listeners dos Modais
            document.getElementById('cancel-password-btn').addEventListener('click', fecharModalSenha);
            document.getElementById('confirm-password-btn').addEventListener('click', confirmarSenha);
            passwordModal.addEventListener('click', (e) => {
                if (e.target === passwordModal) fecharModalSenha();
            });
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) fecharFormularioEdicao();
            });

            // Lógica do Tema
            const temaSalvo = localStorage.getItem('theme');
            const prefereEscuro = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const ehEscuro = temaSalvo === 'dark' || (temaSalvo === null && prefereEscuro);
            setTema(ehEscuro);

            themeToggleBtn.addEventListener('click', () => {
                const isDark = document.documentElement.classList.contains('dark');
                setTema(!isDark);
            });

            selectLivro.addEventListener('change', () => {
                const nomeLivro = selectLivro.value;
                const todosLivros = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
                const numCapitulos = todosLivros[nomeLivro];

                selectCapitulo.innerHTML = ''; // Limpa opções anteriores

                if (numCapitulos) {
                    selectCapitulo.disabled = false;
                    selectCapitulo.innerHTML = '<option value="" disabled selected>Selecione</option>';
                    for (let i = 1; i <= numCapitulos; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        selectCapitulo.appendChild(option);
                    }
                } else {
                    selectCapitulo.disabled = true;
                    selectCapitulo.innerHTML = '<option value="">Selecione o livro</option>';
                }
            });
        });
    </script>
</body>
</html>
