<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
        }
        .bg-custom-blue {
            background-color: #4a6da7;
        }
        .hover\:bg-custom-blue-dark:hover {
            background-color: #3e5a8a;
        }
        .tab-active {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }
        .tab-inactive {
            color: #6b7280;
        }
        .tab-inactive:hover {
            color: #2563eb;
        }
        /* Estilos para a notificação (Toast) */
        .toast {
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        /* Estilo para desabilitar elementos */
        .disabled-form fieldset {
            pointer-events: none;
            opacity: 0.5;
        }
        /* Estilo para capítulo com destaque */
        .has-highlight {
            background-color: #4a6da7;
            color: white;
            border-color: #3e5a8a;
        }
        .has-highlight:hover {
            background-color: #3e5a8a;
        }
        /* Estilos para o Modal */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl">
        <div class="bg-white shadow-md min-h-screen">

            <!-- Navegação com Abas -->
            <nav class="border-b sticky top-0 bg-white z-10">
                <div class="px-8 py-3 flex space-x-8">
                    <a href="#" id="tab-livros" class="text-sm font-semibold pb-3 tab-active flex items-center">
                        <svg class="w-4 h-4 mr-1.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 1.25l-7.5 7.5 7.5 7.5 7.5-7.5-7.5-7.5z"></path></svg>
                        DESTAQUES
                    </a>
                    <a href="#" id="tab-destaques" class="text-sm font-semibold pb-3 tab-inactive">ADICIONAR DESTAQUES</a>
                </div>
            </nav>

            <!-- Visualização dos Livros -->
            <main id="view-livros">
                <div class="p-4 sm:p-8 space-y-8">
                    <section id="antigo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 mb-4">ESCRITURAS HEBRAICO-ARAMAICAS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 border border-gray-300"></div>
                    </section>
                    <section id="novo-testamento">
                        <h2 class="text-sm font-semibold tracking-wider text-gray-600 mb-4">ESCRITURAS GREGAS CRISTÃS</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-300 border border-gray-300"></div>
                    </section>
                </div>
            </main>
            
            <!-- Visualização Adicionar Destaques -->
            <div id="view-destaques" class="hidden p-4 sm:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Adicionar Destaque</h2>
                <form id="form-destaque" class="space-y-4 max-w-lg disabled-form">
                    <fieldset>
                        <div>
                            <label for="input-autor" class="block text-sm font-medium text-gray-700">Seu Nome</label>
                            <input type="text" id="input-autor" name="autor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="select-livro" class="block text-sm font-medium text-gray-700">Livro</label>
                            <select id="select-livro" name="livro" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="input-capitulo" class="block text-sm font-medium text-gray-700">Capítulo</label>
                                <input type="number" id="input-capitulo" name="capitulo" min="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="input-versiculo" class="block text-sm font-medium text-gray-700">Versículo</label>
                                <input type="number" id="input-versiculo" name="versiculo" min="1" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label for="textarea-destaque" class="block text-sm font-medium text-gray-700">Destaque</label>
                            <textarea id="textarea-destaque" name="destaque" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
                        </div>
                        <div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm transition-colors">Salvar Destaque</button>
                        </div>
                    </fieldset>
                </form>
            </div>

            <!-- Visualização dos Capítulos (Grid de números) -->
            <div id="view-capitulos" class="hidden">
                 <header class="p-4 sm:p-6 border-b">
                    <button id="btn-voltar-livros" class="text-blue-600 hover:underline text-sm mb-6">&larr; Voltar para Livros</button>
                    <h1 id="titulo-livro-capitulos" class="text-3xl font-bold text-slate-800"></h1>
                </header>
                <div class="p-4 sm:p-8">
                    <h3 class="font-semibold text-gray-700 mb-4">Capítulos</h3>
                    <div id="grid-capitulos" class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-12 gap-2"></div>
                </div>
            </div>

            <!-- Visualização do Conteúdo do Capítulo (com destaques) -->
            <div id="view-conteudo" class="hidden">
                <header class="p-4 sm:p-6 border-b">
                    <button id="btn-voltar-capitulos" class="text-blue-600 hover:underline text-sm mb-6">&larr; Voltar para Capítulos</button>
                    <h1 id="titulo-conteudo" class="text-3xl font-bold text-slate-800"></h1>
                </header>
                <div id="destaques-container" class="p-4 sm:p-8 space-y-4"></div>
            </div>
        </div>
    </div>

    <!-- Container para as notificações (Toasts) -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>
    
    <!-- Modal de Exclusão -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40 modal-overlay">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Exclusão</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-4">Para excluir este destaque, por favor, insira a senha.</p>
                    <input type="password" id="delete-password" placeholder="Senha" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Senha incorreta.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 mr-2">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, setLogLevel, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase fornecida pelo usuário
        const firebaseConfig = {
            apiKey: "AIzaSyAKG3DUkXfs1DzkJqK9gNW3NbBsQUmtYVo",
            authDomain: "destaques-627c7.firebaseapp.com",
            projectId: "destaques-627c7",
            storageBucket: "destaques-627c7.firebasestorage.app",
            messagingSenderId: "748367852239",
            appId: "1:748367852239:web:ef84cffe6355e87392bdba",
            measurementId: "G-1LRM7D0MY1"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        let userId = null;
        let docIdParaDeletar = null;

        const biblia = {
            "Antigo Testamento": {"Gênesis": 50, "Êxodo": 40, "Levítico": 27, "Números": 36, "Deuteronômio": 34, "Josué": 24, "Juízes": 21, "Rute": 4, "1 Samuel": 31, "2 Samuel": 24, "1 Reis": 22, "2 Reis": 25, "1 Crônicas": 29, "2 Crônicas": 36, "Esdras": 10, "Neemias": 13, "Ester": 10, "Jó": 42, "Salmos": 150, "Provérbios": 31, "Eclesiastes": 12, "Cântico de Salomão": 8, "Isaías": 66, "Jeremias": 52, "Lamentações": 5, "Ezequiel": 48, "Daniel": 12, "Oseias": 14, "Joel": 3, "Amós": 9, "Obadias": 1, "Jonas": 4, "Miqueias": 7, "Naum": 3, "Habacuque": 3, "Sofonias": 3, "Ageu": 2, "Zacarias": 14, "Malaquias": 4},
            "Novo Testamento": {"Mateus": 28, "Marcos": 16, "Lucas": 24, "João": 21, "Atos": 28, "Romanos": 16, "1 Coríntios": 16, "2 Coríntios": 13, "Gálatas": 6, "Efésios": 6, "Filipenses": 4, "Colossenses": 4, "1 Tessalonicenses": 5, "2 Tessalonicenses": 3, "1 Timóteo": 6, "2 Timóteo": 4, "Tito": 3, "Filemom": 1, "Hebreus": 13, "Tiago": 5, "1 Pedro": 5, "2 Pedro": 3, "1 João": 5, "2 João": 1, "3 João": 1, "Judas": 1, "Apocalipse": 22}
        };
        
        let estadoAtual = { livro: null, capitulo: null };

        const views = {
            livros: document.getElementById('view-livros'),
            destaques: document.getElementById('view-destaques'),
            capitulos: document.getElementById('view-capitulos'),
            conteudo: document.getElementById('view-conteudo'),
        };
        const tabs = {
            livros: document.getElementById('tab-livros'),
            destaques: document.getElementById('tab-destaques'),
        };
        const formDestaque = document.getElementById('form-destaque');
        const selectLivro = document.getElementById('select-livro');
        const deleteModal = document.getElementById('delete-modal');
        const passwordError = document.getElementById('password-error');

        function showToast(message, isSuccess = true, showReload = false) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = isSuccess ? 'bg-green-500' : 'bg-red-500';
            toast.className = `toast text-white p-4 rounded-md shadow-lg flex items-center justify-between ${bgColor}`;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            toast.appendChild(messageSpan);

            if (showReload) {
                const reloadButton = document.createElement('button');
                reloadButton.textContent = 'Recarregar';
                reloadButton.className = 'ml-4 bg-white/20 hover:bg-white/30 text-white font-bold py-1 px-3 rounded';
                reloadButton.onclick = () => location.reload();
                toast.appendChild(reloadButton);
            }

            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);

            if (!showReload) {
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            }
        }

        function esconderTudo() { Object.values(views).forEach(view => view.classList.add('hidden')); }

        function popularSelectLivros() {
            selectLivro.innerHTML = '<option value="" disabled selected>Selecione um livro</option>';
            const todosLivros = {...biblia["Antigo Testamento"], ...biblia["Novo Testamento"]};
            Object.keys(todosLivros).forEach(livro => {
                const option = document.createElement('option');
                option.value = livro;
                option.textContent = livro;
                selectLivro.appendChild(option);
            });
        }

        async function salvarDestaque(event) {
            event.preventDefault();
            if (!userId) {
                showToast("Erro: Usuário não autenticado.", false);
                return;
            }
            const formData = new FormData(formDestaque);
            const destaqueData = {
                autor: formData.get('autor'),
                livro: formData.get('livro'),
                capitulo: parseInt(formData.get('capitulo'), 10),
                versiculo: parseInt(formData.get('versiculo'), 10),
                texto: formData.get('destaque'),
                createdAt: new Date()
            };

            try {
                const collectionPath = `destaques/${userId}/items`;
                await addDoc(collection(db, collectionPath), destaqueData);
                showToast("Destaque salvo com sucesso!");
                formDestaque.reset();
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showToast("Falha ao salvar o destaque.", false);
            }
        }

        function popularLivros() {
            const containerAntigo = document.querySelector('#antigo-testamento .grid');
            const containerNovo = document.querySelector('#novo-testamento .grid');
            containerAntigo.innerHTML = '';
            containerNovo.innerHTML = '';
            const criarBotao = (nome, caps) => {
                const div = document.createElement('div');
                div.textContent = nome;
                div.className = 'bg-custom-blue hover:bg-custom-blue-dark text-white font-medium p-4 text-center cursor-pointer transition-colors duration-200';
                div.onclick = () => mostrarCapitulos(nome, caps);
                return div;
            };
            Object.entries(biblia["Antigo Testamento"]).forEach(([l, c]) => containerAntigo.appendChild(criarBotao(l, c)));
            Object.entries(biblia["Novo Testamento"]).forEach(([l, c]) => containerNovo.appendChild(criarBotao(l, c)));
        }

        async function mostrarCapitulos(nomeLivro, numCapitulos) {
            if (!userId) {
                showToast("Aguarde, autenticando...", false);
                return;
            }
            estadoAtual.livro = nomeLivro;
            esconderTudo();
            views.capitulos.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-livro-capitulos').textContent = `O Livro de ${nomeLivro}`;
            const grid = document.getElementById('grid-capitulos');
            grid.innerHTML = '<p class="text-gray-500 col-span-full">Verificando destaques...</p>';

            const capitulosComDestaque = new Set();
            try {
                const collectionPath = `destaques/${userId}/items`;
                const q = query(collection(db, collectionPath), where("livro", "==", nomeLivro));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    capitulosComDestaque.add(doc.data().capitulo);
                });
            } catch (e) {
                console.error("Erro ao verificar destaques: ", e);
                showToast("Erro ao verificar destaques.", false);
            }

            grid.innerHTML = '';

            for (let i = 1; i <= numCapitulos; i++) {
                const capButton = document.createElement('button');
                capButton.textContent = i;
                let classes = 'border border-gray-300 rounded-sm p-2 text-center focus:outline-none focus:ring-2 focus:ring-blue-400 transition-colors duration-200';
                
                if (capitulosComDestaque.has(i)) {
                    classes += ' has-highlight';
                } else {
                    classes += ' hover:bg-gray-100';
                }
                
                capButton.className = classes;
                capButton.onclick = () => mostrarConteudo(nomeLivro, i);
                grid.appendChild(capButton);
            }
        }
        
        async function deletarDestaque(docId) {
            if (!userId || !docId) {
                showToast("Erro ao deletar: ID do usuário ou do documento ausente.", false);
                return;
            }
            try {
                const collectionPath = `destaques/${userId}/items`;
                await deleteDoc(doc(db, collectionPath, docId));
                showToast("Destaque removido.");
                mostrarConteudo(estadoAtual.livro, estadoAtual.capitulo);
            } catch (error) {
                console.error("Erro ao deletar destaque: ", error);
                showToast("Falha ao remover o destaque.", false);
            }
        }

        async function mostrarConteudo(nomeLivro, numCapitulo) {
            estadoAtual.livro = nomeLivro;
            estadoAtual.capitulo = numCapitulo;
            esconderTudo();
            views.conteudo.classList.remove('hidden');
            window.scrollTo(0, 0);
            document.getElementById('titulo-conteudo').textContent = `${nomeLivro} ${numCapitulo}`;
            const container = document.getElementById('destaques-container');
            container.innerHTML = '<p class="text-gray-500">Carregando destaques...</p>';

            if (!userId) {
                container.innerHTML = '<p class="text-red-500">Erro de autenticação. Não é possível carregar destaques.</p>';
                return;
            }

            try {
                const collectionPath = `destaques/${userId}/items`;
                const q = query(collection(db, collectionPath), where("livro", "==", nomeLivro), where("capitulo", "==", numCapitulo));
                const querySnapshot = await getDocs(q);
                const destaquesDoCapitulo = [];
                querySnapshot.forEach((doc) => destaquesDoCapitulo.push({ id: doc.id, ...doc.data() }));

                destaquesDoCapitulo.sort((a, b) => a.versiculo - b.versiculo);

                container.innerHTML = '';
                if (destaquesDoCapitulo.length > 0) {
                    destaquesDoCapitulo.forEach(({ id, versiculo, texto, autor }) => {
                        const card = document.createElement('div');
                        card.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50 flex justify-between items-start';
                        card.innerHTML = `
                            <div>
                                <p class="font-bold text-blue-600">Versículo ${versiculo}</p>
                                <p class="mt-2 text-gray-700 whitespace-pre-wrap">${texto}</p>
                                <p class="text-xs text-gray-500 mt-3 italic">Destaque de: ${autor || 'Anônimo'}</p>
                            </div>
                            <button data-doc-id="${id}" class="delete-btn text-gray-400 hover:text-red-500 p-1 ml-4 flex-shrink-0">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                            </button>
                        `;
                        container.appendChild(card);
                    });
                    container.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', () => abrirModalDelecao(button.dataset.docId));
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500">Nenhum destaque salvo para este capítulo.</p>';
                }
            } catch(e) {
                console.error("Erro ao buscar destaques: ", e);
                container.innerHTML = '<p class="text-red-500">Ocorreu um erro ao carregar os destaques.</p>';
            }
        }

        function mudarAba(abaAtiva) {
            esconderTudo();
            Object.values(tabs).forEach(tab => tab.classList.replace('tab-active', 'tab-inactive'));
            if (abaAtiva === 'livros') {
                views.livros.classList.remove('hidden');
                tabs.livros.classList.replace('tab-inactive', 'tab-active');
            } else if (abaAtiva === 'destaques') {
                views.destaques.classList.remove('hidden');
                tabs.destaques.classList.replace('tab-inactive', 'tab-active');
            }
        }
        
        function abrirModalDelecao(docId) {
            docIdParaDeletar = docId;
            deleteModal.classList.remove('hidden');
        }

        function fecharModalDelecao() {
            deleteModal.classList.add('hidden');
            document.getElementById('delete-password').value = '';
            passwordError.classList.add('hidden');
            docIdParaDeletar = null;
        }

        function confirmarDelecao() {
            const password = document.getElementById('delete-password').value;
            if (password === 'xetays2468') {
                deletarDestaque(docIdParaDeletar);
                fecharModalDelecao();
            } else {
                passwordError.classList.remove('hidden');
            }
        }

        async function inicializarApp() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Falha na autenticação:", error);
                showToast("Falha na autenticação.", false, true);
            }
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                formDestaque.classList.remove('disabled-form');
            } else {
                userId = null;
                formDestaque.classList.add('disabled-form');
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            inicializarApp();
            popularLivros();
            popularSelectLivros();

            formDestaque.addEventListener('submit', salvarDestaque);
            tabs.livros.addEventListener('click', (e) => { e.preventDefault(); mudarAba('livros'); });
            tabs.destaques.addEventListener('click', (e) => { e.preventDefault(); mudarAba('destaques'); });
            document.getElementById('btn-voltar-livros').addEventListener('click', () => mudarAba('livros'));
            document.getElementById('btn-voltar-capitulos').addEventListener('click', () => {
                const livro = estadoAtual.livro;
                const numCapitulos = biblia["Antigo Testamento"][livro] || biblia["Novo Testamento"][livro];
                mostrarCapitulos(livro, numCapitulos);
            });
            
            // Event Listeners do Modal
            document.getElementById('cancel-delete-btn').addEventListener('click', fecharModalDelecao);
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmarDelecao);
            deleteModal.addEventListener('click', (e) => {
                if (e.target === deleteModal) {
                    fecharModalDelecao();
                }
            });
        });
    </script>
</body>
</html>
